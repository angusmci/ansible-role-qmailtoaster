# qmailtoaster

This is an ansible role for installing the `qmailtoaster` mail package, based on `qmail`.

For more information about `qmailtoaster`, see [qmailtoaster.com](http://qmailtoaster.com).

This is a port to ansible of Eric Broch's install scripts. It is intended to complement Eric's install process, providing a way to install `qmailtoaster` that some administrators may find easier than a shell script-based approach. It depends heavily on the packages and other tools developed by Eric, and will not function without them.

Any bugs in the role are my fault, not Eric's.

Thanks to the present and past maintainers of `qmailtoaster`, Eric Broch and Eric Shubert, for all their hard work in maintaining, updating and extending the `qmailtoaster` system. Thanks also to other members of the `qmailtoaster` community, such as Remo Mattei, for their help and comments, and special thanks to Remi Collet for help with installing his PHP repos. Thanks are due also to Daniel Bernstein, the original author of `qmail`, and to everyone else who has contributed to the `qmailtoaster` ecosystem.

THIS ROLE IS STILL UNDER ACTIVE DEVELOPMENT, AND HAS NOT BEEN FULLY TESTED. IT IS NOT RECOMMENDED FOR PRODUCTION SYSTEMS. THERE IS NO WARRANTY, EXPRESS OR IMPLIED.

CURRENTLY, THE ROLE IS ONLY SUITABLE FOR INSTALLING ON CENTOS 8 SYSTEMS. THE CENTOS 7 INSTALLATION MAY BE RESTORED IN FUTURE. THERE ARE NO PLANS TO SUPPORT INSTALLATION ON ANY OTHER DISTROS, INCLUDING CENTOS 6.

## Requirements

TBD

## How to use this role

### Installation

The role is not yet available on `ansible-galaxy`. In the interim, you can download it from Github by adding:

- src: https://github.com/angusmci/ansible-role-qmailtoaster.git
  version: HASH-GOES-HERE

to your `ansible-galaxy` install file. Replace the string HASH-GOES-HERE with the latest commit hash from the role’s Github page. 

CURRENTLY, ALL NEW DEVELOPMENT IS ON THE `COS8` BRANCH.

### Usage

Set up a new, clean CentOS 8 system and perform whatever tasks you need to do to secure and prepare your system. This should include installing security certificates for both the webserver and the mailserver.

By default, the role will expect to find appropriate certificates and related files at:

	/etc/pki/tls/certs/server.crt
	/etc/pki/tls/certs/server-ca-bundle.crt
	/etc/pki/tls/private/server.key
	
(you can change the names of the files but not their paths as part of your configuration). Consult your SSL certificate provider for information about generating and obtaining these files.

After installation, you will also need to add a PEM file to:

	/var/qmail/control/servercert.pem
	
to allow encrypted mail transactions. The PEM file is generated by concatenating your key and server certificate.

To invoke the role, add the following to your playbook:

	- name: install qmailtoaster
      include_role:
        name: ansible-role-qmailtoaster
      vars:
	    ... variables go here ...
	    
Under `vars`, you will enter all the configuration variables that you wish to define or override. These variables are defined in `vars/main.yml` and documented below.

## Configuration Variables

The behavior of the role is controlled by various role variables. These are used to specify options (such as whether to install a particular optional package or not). They are also used to specify database passwords and other settings.

### Password variables

The default `vars/main.yml` file in the role does not provide definitions for the database passwords used in the role. Therefore, if you simply run the role without specifying these passwords, the role will fail with an error. This is intentional: for the security of your system, you should provide good, non-default passwords.

The standard `qmailtoaster` install scripts specify some rather weak default passwords. This arguably represents a possible small security risk. For greater security, this role requires you to specify your own passwords.

When choosing passwords, you are recommended to avoid using certain characters, specifically punctuation that has special meaning to the shell (e.g. '&', '|', ' ' or '!') or in SQL (e.g. semicolons and various types of quotes). This is because some parts of the install process require the passwords to be passed to the shell or to MariaDB, and Ansible isn't always entirely helpful in the way that it handles quoted strings. Using special characters can cause problems. Using alphanumerics and a restricted set of punctuation characters (e.g. '=', '-', '\_', '+', '.', ',') should be safe.

Password variables used are:

    qmt_db_root_password:
    qmt_db_vpopmail_password:
    qmt_db_dspam_password:
    qmt_db_roundcube_password:
    qmt_rainloop_admin_password:
    
You should provide your own values for all of these.

### General QMailToaster configuration

The following sets of variables can be configured to customize the install. These are all optional: sensible defaults are provided.

#### Installation options

	qmt_install_roundcube: yes
	
Should the `roundcube` webmail client be installed?

	qmt_install_rainloop: yes
	
Should the `rainloop` webmail client be installed?

	qmt_install_dspam: no

Should the `dspam` spam filtering system be installed? (CURRENTLY NOT SUPPORTED)

	qmt_install_vpopmaild: no
	
Should the daemonized vpopmail be installed? (CURRENTLY NOT SUPPORTED)

#### Database options

	qmt_database: mariadb
	
Database system to be used. The options are `mysql` or `mariadb`: `mariadb` is an open-source alternative to `mysql` that behaves like `mysql` in most important respects.

    qmt_db_secure: yes
    
Should the database be secured after installation? The default value of ‘yes’ will remove test databases and users. Do not change it to ‘no’ unless you have a very good reason to do so.

	qmt_db_credfile: ~/sql.cnf
	
Path to the `sql.cnf` credentials file that will be used during installation.

### Squirrelmail configuration

Configuration options for the Squirrelmail webmail client. These change the texts and links that appear in the Squirrelmail user interface. If you use Squirrelmail, you will want to change these to something appropriate for your organization.

	qmt_squirrelmail_org_name: "Qmailtoaster"

	qmt_squirrelmail_provider_uri: "http://qmailtoaster.com/"

	qmt_squirrelmail_provider_name: "Qmailtoaster"

### Roundcube configuration

Configuration options for the RoundCube webmail client.

	qmt_roundcube_des_key: "Change_this_24Byte_Str!!"
	
DES key used by the RoundCube client. Change this to a different string that is exactly 24 bytes in length.

	qmt_roundcube_support_url: ""
	
URL to a support page for users of the RoundCube client, such as the homepage for your organization’s helpdesk.

	qmt_roundcube_product_name: "Roundcube Webmail"
	
Product name for the webmail client, shown in the user interface. You could change it to include your organization's name.

### Rainloop configuration

	qmt_rainloop_license: community
	
Version of Rainloop to install. ‘community' will install the Community edition, which is a GPL-licensed open-source version. ‘standard’ will install the Standard edition, which is free to use on non-commercial websites, but must be licensed for use on commercial sites. 

	qmt_rainloop_domains: []
	
This is a list of domains to create for use with `rainloop`. The list should have the form:

	- domain: domain1.com
	    imap_host: imap.domain1.com
	    smtp_host: smtp.domain1.com
	- domain: domain2.com
	    imap_host: mail.domain2.com
	    smtp_host: mail.domain2.com

There are other Rainloop configuration options, but you can probably leave all of these at the defaults. If you want to configure the Rainloop application in ways that aren't supported by this role, you should use your own template and tasks.

These variable names are intended to be self-explanatory. If they don't make sense to you, look in 'rainloop_application_ini.j2' to see how they're used.

	qmt_rainloop_title: RainLoop Webmail
	qmt_rainloop_theme: Default
	qmt_rainloop_default_language: en
	qmt_rainloop_admin_language: en
	qmt_rainloop_admin_name: admin
	qmt_rainloop_admin_password: 12345

### Tuning

Assorted options for fine-tuning the installation.

	qmt_spf_behavior: 3
	
SPF behavior for this toaster. See [SPF](http://wiki.qmailtoaster.com/index.php/Spf) for more information. The default setting is 3, which rejects email when SPF resolves to fail. 

	qmt_timezone: "America/New_York"

Timezone for server, e.g. "America/Denver", "America/New_York" etc

	qmt_crypto_policy: DEFAULT

Cryptographic policies for qmailtoaster. This should normally be DEFAULT. If you need to support users on Windows 7 with Outlook 2010, change it to LEGACY

	qmt_attachment_size_limit: 10

Maximum size of attachments that can be posted through web UIs on this server.

### vpopmail

These options are generally used only during the initial installation, and relate to the vpopmail system. 

	qmt_vpopmail_dump_file_path: /tmp/vpopmail.sql

If a vpopmail database already exists, back it up to this file.

	qmt_vpopmail_rebuild_database: false

Force a rebuild of the database. This is potentially dangerous, because it will destroy any domain tables created by 'vadddomain', which will cause 'vadduser' to fail later. If you set this to true, be prepared to clean up the mess manually.

### SSL Configuration

	qmt_use_httpd_ssl: no

When this option is set to true, '/etc/httpd/conf.d/ssl.conf' will be modified to use a user-provided key, certificate and bundle files, as opposed to using  self-signed certificates. For production servers you will generally want to set this to ‘yes’.

	qmt_httpd_ssl_certificate_file: server.crt

Name of the SSL certificate file. This file should be placed in `/etc/pki/tls/certs/`.

	qmt_httpd_ssl_certificate_authority_file: server-ca-bundle.crt

Name of the SSL certificate authority file. This file should be placed in `/etc/pki/tls/certs/`.

	qmt_httpd_ssl_certificate_key_file: server.key
	
Name of the SSL certificate key file. This file should be placed in `/etc/pki/tls/private/`.

### Other

	qmt_toast_aclnet: "192.168.2.0\/24 192.168.9.0\/24 127.0.0.1"

ACL definitions for access to web management tools. Slashes in netblock CIDR expressions should be escaped, e.g. "192.168.2.0\/24" and entries should be space-separated.

## Dependencies

TBD

## Example Playbook

Here is an example of invoking the role.

    - name: install qmailtoaster
      include_role:
    	name: ansible-role-qmailtoaster
      vars:
    	qmt_db_secure_: yes
    	qmt_install_vpopmaild: yes
    	qmt_install_roundcube: yes
    	qmt_install_rainloop: yes
    	qmt_db_root_password: "{{ my_password1 }}"
    	qmt_db_vpopmail_password: "{{ my_password2 }}"
    	qmt_db_roundcube_password: "{{ my_password4 }}"
    	qmt_roundcube_des_key: "an.3x4mpl3.DES.key.12345"
    	qmt_rainloop_license: community
    	qmt_rainloop_domains:
    	  - domain: example.com
    		imap_host: server1.example.com
    		smtp_host: server2.example.com
    	  - domain: example.net
    		imap_host: mail.example.net
    		smtp_host: mail.example.net
    	qmt_use_httpd_ssl: yes
    	qmt_timezone: America/New_York
    	qmt_rainloop_admin_password: "{{ my_password5 }}"
    	qmt_attachment_size_limit: 25

## License

BSD

## Author Information

Ansible role

- Angus McIntyre -- http://nomadcode.com/

Qmailtoaster install script

- Eric Broch -- http://whitehorsetc.com/
- Eric Shubert
